<div class="app-shell" data-controller="sidebar">
  <%# Sidebar %>
  <aside class="sidebar" data-sidebar-target="panel">
    <div class="sidebar__top">
      <div class="sidebar__brand">
        <%= image_tag "Logo SimpliCity.png", alt: "Logo SimpliCity" %>
      </div>

      <% if user_signed_in? %>
        <div class="sidebar__section" data-sidebar-target="scenarioSection" hidden>
          <div class="sidebar__label">ESCENARIO</div>

          <select class="sidebar__select"
                  data-sidebar-target="scenarioSelect"
                  data-action="change->sidebar#scenarioChanged"
                  disabled>
            <option>Seleccionar escenario...</option>
          </select>

          <div class="sidebar__hint sidebar__hint--center" data-sidebar-target="scenarioHint">
            Selecciona una comuna para ver tus escenarios
          </div>
        </div>

        <button
          type="button"
          class="sidebar__danger-btn"
          data-sidebar-target="deleteScenarioBtn"
          data-action="click->sidebar#deleteScenario"
          hidden
        >
          üóëÔ∏è Eliminar escenario
        </button>


        <div class="sidebar__divider"></div>
      <% end %>


      <div class="sidebar__section">
        <div class="sidebar__label">REGI√ìN</div>
        <select class="sidebar__select" data-sidebar-target="regionSelect" data-action="change->sidebar#regionChanged">
          <option>Seleccionar regi√≥n...</option>
        </select>
      </div>

      <div class="sidebar__section">
        <div class="sidebar__label">COMUNA</div>
        <select class="sidebar__select" data-sidebar-target="municipalitySelect" data-action="change->sidebar#municipalityChanged">
          <option>Seleccionar comuna...</option>
        </select>
      </div>

      <div class="sidebar__section">
        <div class="sidebar__label">OPORTUNIDADES</div>
        <select class="sidebar__select" data-sidebar-target="opportunitySelect" data-action="change->sidebar#opportunityChanged" disabled>
          <option>Seleccionar oportunidad</option>
        </select>
        <div class="sidebar__hint">
          Selecciona primero una comuna en el mapa o en el buscador
        </div>
      </div>

      <div class="sidebar__divider"></div>

      <div class="sidebar__section" data-sidebar-target="layerSection" hidden>
        <div class="sidebar__label">CAPAS DE DATOS</div>

        <div class="sidebar__layers">
          <button
            type="button"
            class="sidebar__layer-btn"
            data-metric="surface"
            data-action="click->sidebar#selectLayer"
          >
            <i class="fa-solid fa-square"></i>Superficie construida
          </button>

          <button
            type="button"
            class="sidebar__layer-btn"
            data-metric="units"
            data-action="click->sidebar#selectLayer"
          >
            <i class="fa-solid fa-building"></i>Unidades construidas
          </button>

          <button
            type="button"
            class="sidebar__layer-btn"
            data-layer="accessibility"
            data-action="click->sidebar#selectLayer"
          >
            üö∂ Accesibilidad
          </button>

          <div class="sidebar__subchoices" data-sidebar-target="accessibilityChoices" hidden>
            <button
              type="button"
              class="sidebar__subchoice-btn"
              data-mode="walk"
              data-action="click->sidebar#selectAccessibilityMode"
            >
              Caminata
            </button>

            <button
              type="button"
              class="sidebar__subchoice-btn"
              data-mode="car"
              data-action="click->sidebar#selectAccessibilityMode"
            >
              Autom√≥vil
            </button>
          </div>

        </div>
      </div>

      <div
        class="sidebar__section"
        data-sidebar-target="locateSection"
        hidden
      >
        <button
          type="button"
          class="sidebar__primary-btn"
          data-action="click->sidebar#toggleLocator"
        >
          üìç Localizar infraestructura
        </button>
      </div>



    <div class="sidebar__bottom">
      <button class="sidebar__link" type="button">
        <span class="sidebar__icon">‚öôÔ∏è</span> Configuraci√≥n
      </button>
      <button class="sidebar__link" type="button">
        <span class="sidebar__icon">‚ùî</span> Ayuda
      </button>
    </div>
  </aside>

  <!-- Sidebar secundaria (Localizador) -->
  <aside class="sidebar sidebar--secondary" data-sidebar-target="locatorPanel" hidden>
    <div class="sidebar__top">
      <button type="button" class="sidebar__close-btn" data-action="click->sidebar#toggleLocator">
        ‚úñ
      </button>
      <div class="sidebar__header">Localizador</div>

      <div class="sidebar__section" data-sidebar-target="previousProjectsSection">
        <div class="sidebar__label">PROYECTOS ANTERIORES (HISTORIAL)</div>
        <div class="locator-projects" data-sidebar-target="previousProjectsList"></div>
      </div>

      <div class="sidebar__divider"></div>

      <div class="sidebar__section">
        <div class="sidebar__label">PROYECTOS EN BORRADOR</div>
        <div class="locator-projects" data-sidebar-target="draftProjectsList"></div>
      </div>

      <div class="sidebar__divider"></div>

      <div class="sidebar__section">
        <div class="sidebar__label">NOMBRE DEL PROYECTO</div>
        <input
          class="sidebar__input"
          type="text"
          placeholder="Ej: Cesfam Sector Norte"
          data-sidebar-target="projectNameInput"
        />
      </div>


      <div class="sidebar__label">CELDA</div>

      <div class="locator-cell">
        <input
          class="sidebar__input"
          type="text"
          placeholder="Selecciona una celda..."
          data-sidebar-target="selectedCellDisplay"
          readonly
        />

        <button type="button"
                class="sidebar__secondary-btn"
                data-action="click->sidebar#startPickCell">
          Seleccionar celda
        </button>
      </div>

      <input type="hidden" data-sidebar-target="selectedCellH3" />

      <div class="sidebar__section">
        <div class="sidebar__label">OPORTUNIDAD</div>
        <select class="sidebar__select" data-sidebar-target="locatorOpportunitySelect" disabled>
          <option>Seleccionar oportunidad</option>
        </select>
      </div>

      <div class="sidebar__section">
        <div class="sidebar__label">UNIDADES</div>
        <input
          class="sidebar__input"
          type="number"
          min="1"
          step="1"
          inputmode="numeric"
          placeholder="Ej: 10"
          data-sidebar-target="unitsInput"
        />
      </div>

      <div class="sidebar__section">
        <div class="sidebar__label">SUPERFICIE POR UNIDAD</div>
        <input
          class="sidebar__input"
          type="number"
          min="1"
          step="1"
          inputmode="numeric"
          placeholder="Ej: 65"
          data-sidebar-target="areaPerUnitInput"
        />
      </div>

      <div class="sidebar__section">
        <button type="button"
                class="sidebar__primary-btn"
                data-sidebar-target="addBtn"
                data-action="click->sidebar#addProject">
          Agregar
        </button>
      </div>

      <div class="sidebar__section">
        <button type="button"
                class="sidebar__secondary-btn"
                data-sidebar-target="saveRecalcBtn"
                data-action="click->sidebar#openPublishModal">
          Guardar y recalcular
        </button>
      </div>
    </div>
  </aside>


  <!-- Bot√≥n de colapsar -->
  <button
    class="sidebar__collapse"
    type="button"
    aria-label="Colapsar sidebar"
    data-action="click->sidebar#toggle"
    data-sidebar-target="toggle"
  >
    ‚Äπ
  </button>

  <div
    class="user-menu"
    data-controller="user-menu"
    data-user-menu-open-value="false"
  >
    <button type="button"
            class="user-menu__btn"
            aria-label="Usuario"
            data-action="click->user-menu#toggleMenu">

      <% if user_signed_in? %>
        <span class="user-menu__initial">
          <%= current_user.email.first.upcase %>
        </span>
      <% else %>
        <i class="fa-solid fa-circle-user"></i>
      <% end %>

    </button>

    <div class="user-menu__dropdown" data-user-menu-target="dropdown" hidden>
      <% if user_signed_in? %>

        <div class="user-menu__item user-menu__item--muted">
          <%= current_user.email %>
        </div>

        <%= button_to "Cerrar sesi√≥n",
              destroy_user_session_path,
              method: :delete,
              form: { data: { turbo: false } },
              class: "user-menu__item user-menu__item--button" %>

      <% else %>

        <%= link_to "Iniciar sesi√≥n",
              new_user_session_path,
              class: "user-menu__item",
              data: { action: "click->user-menu#openModal",
                      turbo_frame: "auth_modal_frame" } %>

        <%= link_to "Crear cuenta",
              new_user_registration_path,
              class: "user-menu__item",
              data: { action: "click->user-menu#openModal",
                      turbo_frame: "auth_modal_frame" } %>

      <% end %>
    </div>

    <!-- Modal -->
    <div class="auth-modal" data-user-menu-target="modal" hidden>
      <div class="auth-modal__backdrop" data-action="click->user-menu#closeModal"></div>

      <div class="auth-modal__panel" role="dialog" aria-modal="true">
        <button type="button" class="auth-modal__close" data-action="click->user-menu#closeModal">‚úñ</button>

        <turbo-frame id="auth_modal_frame"></turbo-frame>
      </div>
    </div>

  </div>

  <div class="modal" data-sidebar-target="publishModal" hidden>
    <div class="modal__backdrop" data-action="click->sidebar#closePublishModal"></div>

    <div class="modal__panel" role="dialog" aria-modal="true">
      <div class="modal__title">Guardar escenario</div>

      <div class="modal__body">
        <div class="sidebar__label">NOMBRE DEL ESCENARIO</div>
        <input
          class="sidebar__input"
          type="text"
          placeholder="Ej: Comercio + salud 2026-02-19"
          data-sidebar-target="publishNameInput"
        />
        <div class="sidebar__hint sidebar__hint--muted">
          Este nombre se mostrar√° en tu lista de escenarios.
        </div>
      </div>

      <div class="modal__actions">
        <button type="button" class="sidebar__secondary-btn" data-action="click->sidebar#closePublishModal">
          Cancelar
        </button>

        <button type="button" class="sidebar__primary-btn" data-action="click->sidebar#confirmPublishScenario">
          Guardar escenario
        </button>
      </div>
    </div>
  </div>


  <main class="map-area" data-sidebar-target="mapArea">
    <div
      id="map"
      class="map"
      data-controller="map"
      data-map-token-value="<%= ENV.fetch("MAPBOX_TOKEN", "") %>"
    ></div>

    <%# Botones flotantes (derecha) %>
    <div class="map-fab">
      <button type="button" class="map-fab__btn" aria-label="Mapa">
        <i class="fa-solid fa-map"></i>
      </button>

      <button type="button" class="map-fab__btn" aria-label="Gr√°fico">
        <i class="fa-solid fa-chart-bar"></i>
      </button>

      <button type="button" class="map-fab__btn" aria-label="Capas">
        <i class="fa-solid fa-list"></i>
      </button>
    </div>
  </main>

  <div class="pickcell-hint" data-sidebar-target="pickCellModal" hidden>
    <div class="pickcell-hint__panel">
      <div class="pickcell-hint__title">Seleccionar celda</div>
      <div class="pickcell-hint__text">Haz click en una celda del mapa para seleccionarla.</div>
      <div class="pickcell-hint__text pickcell-hint__muted">Presiona ESC para cancelar.</div>
    </div>
  </div>





</div>
